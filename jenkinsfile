// pipeline {
//     agent any
//     environment {
//     DOCKERHUB_CREDENTIALS = credentials('dockerhub')
//     }
//     stages {

//         stage('Build docker image') {
//             steps {
//                 sh 'docker build -t akashnair30/todoapps:$BUILD_NUMBER .'
//             }
//         }
//         stage('login to dockerhub') {
//             steps{
//                 sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'     
//             }
//         }
//         stage('push image') {
//             steps{
//                 sh 'docker push akashnair30/todoapps:$BUILD_NUMBER'
//             }
//         }
//     }
//     post {
//         always {
//             sh 'docker logout'
//         }
//     }
// }

// pipeline {
//     agent any

//     environment {
//         DOCKER_BUILDKIT = "1"
//     }

//     stages {
//         stage('Checkout SCM') {
//             steps {
//                 checkout scm
//             }
//         }
//         stage('Build docker image') {
//             steps {
//                 script {
//                     sh 'docker build -t akashnair30/todoapps:$BUILD_NUMBER .'
//                 }
//             }
//         }
//         stage('Login to DockerHub') {
//             steps {
//                 script {
//                     withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials-id', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
//                         sh 'echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin'
//                     }
//                 }
//             }
//         }
//         stage('Push image') {
//             steps {
//                 script {
//                     sh 'docker push akashnair30/todoapps:$BUILD_NUMBER'
//                 }
//             }
//         }
//     }
//     post {
//         always {
//             cleanWs()
//         }
//     }
// }

// pipeline {
//     agent any

//     environment {
//         DOCKER_BUILDKIT = "1"
//     }

//     stages {
//         stage('Checkout SCM') {
//             steps {
//                 checkout scm
//             }
//         }
//         stage('Set up Docker Buildx') {
//             steps {
//                 script {
//                     // Create and use the Buildx builder
//                     sh 'docker buildx create --name mybuilder --use'
//                     sh 'docker buildx inspect --bootstrap'
//                 }
//             }
//         }
//         stage('Build docker image') {
//             steps {
//                 script {
//                     // Use Buildx to build the image with plain progress output
//                     sh 'docker buildx build --progress=plain --platform linux/amd64 -t akashnair30/todoapps:$BUILD_NUMBER .'
//                 }
//             }
//         }
//         stage('Login to DockerHub') {
//             steps {
//                 script {
//                     withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials-id', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
//                         // Login to DockerHub
//                         sh 'echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin'
//                     }
//                 }
//             }
//         }
//         stage('Push image') {
//             steps {
//                 script {
//                     // Use Buildx to push the image
//                     sh 'docker buildx build --progress=plain --platform linux/amd64 -t akashnair30/todoapps:$BUILD_NUMBER --push .'
//                 }
//             }
//         }
//     }
//     post {
//         always {
//             cleanWs()
//         }
//     }
// }

pipeline {
    agent any

    environment {
        DOCKER_BUILDKIT = "1"
    }

    stages {
        stage('Checkout SCM') {
            steps {
                script {
                    echo "Start Checkout SCM: $(date)"
                    checkout scm
                    echo "End Checkout SCM: $(date)"
                }
            }
        }
        stage('Build docker image') {
            steps {
                script {
                    echo "Start Build docker image: $(date)"
                    sh 'docker build -t akashnair30/todoapps:$BUILD_NUMBER .'
                    echo "End Build docker image: $(date)"
                }
            }
        }
        stage('Login to DockerHub') {
            steps {
                script {
                    echo "Start Login to DockerHub: $(date)"
                    withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials-id', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                        sh 'echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin'
                    }
                    echo "End Login to DockerHub: $(date)"
                }
            }
        }
        stage('Push image') {
            steps {
                script {
                    echo "Start Push image: $(date)"
                    sh 'docker push akashnair30/todoapps:$BUILD_NUMBER'
                    echo "End Push image: $(date)"
                }
            }
        }
    }
    post {
        always {
            cleanWs()
        }
    }
}

